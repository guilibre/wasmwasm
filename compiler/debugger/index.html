<!DOCTYPE html>
<html>
  <head>
    <title>WASM Firefox Debugging</title>
    <script>
      async function loadWasm() {
        const memory = new WebAssembly.Memory({ initial: 64, maximum: 64 });
        this.heap = new Float32Array(memory.buffer);
        const imports = { env: { memory } };
        heap = new Float32Array(memory.buffer);

        const { instance } = await WebAssembly.instantiateStreaming(
          fetch("output.wasm"),
          imports
        );
        instance.exports.init_buffers();
        let output = Array.from({ length: 2 }, () =>
          new Float32Array(256).fill(0)
        );
        const width = output.length;
        const height = output[0].length;
        let before = performance.now();
        for (let i = 0; i < 2000; i++) {
          instance.exports.main(0, height, width);
          for (let i = 0; i < width; ++i)
            output[i].set(this.heap.subarray(i * height, (i + 1) * height));
        }
        console.log("wasm: ", (performance.now() - before) / 1000);

        let TIME = 0;

        before = performance.now();
        for (let i = 0; i < 2000; i++) {
          for (let k = 0; k < height; k++) {
            for (let j = 0; j < width; j++) {
              output[j][k] = Math.sin(880 * Math.PI * TIME);
            }
            TIME += 1;
          }
        }
        console.log("js: ", (performance.now() - before) / 1000);
      }
      loadWasm();
    </script>
  </head>

  <body>
    <p>Open DevTools (F12) to debug WASM.</p>
  </body>
</html>
